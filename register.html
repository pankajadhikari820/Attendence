<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Register | Smart Attendance</title>
  <link rel="stylesheet" href="register.css">
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
  <script src="firebaseConfig.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
  <style>
    .container{max-width:420px;margin:40px auto;padding:20px;border-radius:8px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,.06);font-family:Arial}
    input{width:100%;padding:10px;margin:8px 0;border:1px solid #ccc;border-radius:6px}
    button{padding:10px 14px;border:none;border-radius:6px;background:#1976d2;color:#fff;cursor:pointer}
    .nav-buttons{display:flex;gap:8px;margin-bottom:12px}
    .nav-btn{display:inline-block;padding:6px 10px;background:#eee;border-radius:6px;text-decoration:none;color:#333}
    footer{margin-top:20px;text-align:center;color:#666;font-size:14px}
    .result{margin-top:12px}
    canvas{border:1px solid #ddd;border-radius:6px}
  </style>
</head>
<body>

  <div class="container">
    <h2>Register for Attendance</h2>

    <div class="nav-buttons">
      <a href="index.html" class="nav-btn">Home</a>
      <a href="checkin.html" class="nav-btn">Mark Attendance</a>
    </div>

    <input type="text" id="name" placeholder="Enter Full Name" autocomplete="name">
    <input type="tel" id="mobile" placeholder="Enter Mobile Number (10 digits)" maxlength="10" autocomplete="tel">
    <button onclick="registerUser()">Register</button>

    <div class="result">
      <h3>Your QR Code:</h3>
      <canvas id="qrcode"></canvas>
      <p id="userIdDisplay"></p>
      <button id="downloadQR" style="display:none" onclick="downloadQR()">⬇️ Download QR</button>
    </div>
  </div>

  <footer>
    &copy; 2025 Smart Attendance | Developed by <b>Pankaj</b>
  </footer>

  <script>
    let qr, generatedUserId = '';

    // Clean name
    function sanitizeName(n) {
      return n.replace(/\s+/g, ' ').trim();
    }

    // Generate userId only using name + mobile
    function generateUserId(name, mobile) {
      const safeName = name.trim().toLowerCase().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
      return safeName + '_' + mobile;
    }

    // Mobile number validation: only 10 digits, starts with 6-9
    function isValidIndianMobile(mobile) {
      return /^[6-9]\d{9}$/.test(mobile);
    }

    function registerUser() {
      const nameRaw = document.getElementById('name').value;
      const name = sanitizeName(nameRaw);
      const mobile = document.getElementById('mobile').value.trim();

      // Blank check
      if (!name || !mobile) {
        return alert("⚠️ Please enter both Name and Mobile!");
      }

      // Non-digit check
      if (/[^0-9]/.test(mobile)) {
        return alert("❌ Mobile number should contain only digits!");
      }

      // Mobile number validity
      if (!isValidIndianMobile(mobile)) {
        return alert("⚠️ Invalid mobile number! Enter a 10-digit number starting with 6-9.");
      }

      const usersRef = firebase.database().ref('users');

      // Check duplicate: same name OR same mobile
      const checkMobile = usersRef.orderByChild('mobile').equalTo(mobile).once('value');
      const checkName = usersRef.orderByChild('name').equalTo(name).once('value');

      Promise.all([checkMobile, checkName]).then(([snapMobile, snapName]) => {
        if (snapMobile.exists()) {
          alert("❌ This mobile number is already registered!");
          return;
        }
        if (snapName.exists()) {
          alert("❌ This name is already registered!");
          return;
        }

        // Create ID and store in Firebase
        const userId = generateUserId(name, mobile);
        generatedUserId = userId;
        const registeredAt = new Date().toLocaleString();

        usersRef.child(userId).set({
          userId,
          name,
          mobile,
          registeredAt
        }).then(() => {
          alert("✅ Registered Successfully!");

          qr = new QRious({
            element: document.getElementById('qrcode'),
            value: userId,
            size: 200
          });

          document.getElementById('userIdDisplay').innerText = "Registration ID: " + userId;
          document.getElementById('downloadQR').style.display = "inline-block";
          document.getElementById('name').value = '';
          document.getElementById('mobile').value = '';
        }).catch(err => {
          alert("❌ Error: " + err.message);
        });

      }).catch(err => {
        console.error(err);
        alert("❌ Error checking duplicates: " + err.message);
      });
    }

    function downloadQR() {
      if (!qr) return alert("QR not generated yet!");
      const link = document.createElement('a');
      link.href = qr.toDataURL("image/png");
      link.download = "QR_" + generatedUserId + ".png";
      link.click();
    }
  </script>

</body>
</html>
